<html>
<head>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-42668100-1', 'dpcollins.github.io');
  ga('send', 'pageview');
</script>
<meta charset="utf-8"> 
<meta http-equiv="Cache-control" content="No-Cache">
<style>

path {
/*   fill: teal; */
  fill: #ccc;
/*   stroke: #ccc; */
  stroke: white;
  stroke: #eee;
  stroke-width: .25px;
}

#map {position: fixed;
	  top: 0px;
	  left: 0px;
	  }


path:hover {
	fill: #708DE2;
	opacity: 0.55;
	}


.boundary {

  stroke: grey;
  stroke-linejoin: round;
  stroke-width: 2px;
 
}

path.country.active {
	fill: orange;
	opacity: 0.5;
	}

.country {/*   fill: teal; */
  fill: #ccc;
/*   stroke: #ccc; */
  stroke: white;
  stroke: #eee;
  stroke-width: .25px;
}
	

.mesh {
  fill: none;
  stroke: grey;
  stroke-width: 0.5px;
  stroke-linejoin: round;
}


div.tooltip {
  color: #222; 
  background: #fff; 
  padding: .5em; 
  text-shadow: #f5f5f5 0 1px 0;
  border-radius: 2px; 
  box-shadow: 0px 0px 2px 0px #a6a6a6; 
  opacity: 0.9; 
  position: absolute;
  
  }

div.tooltip.hidden {
	display: none;
	}  


div.tooltip1 {
  color: #333; 
  background: #fff; 
  padding: .5em; 
  text-shadow: #f5f5f5 0 1px 0;
  border-radius: 2px; 
  box-shadow: 0px 0px 2px 0px #a6a6a6; 
  opacity: 0.9; 
  position: absolute;
  line-height: 0.85em;
  
  }

div.tooltip1.hidden {
	display: none;
	opacity: 0;
	}

div.tooltip2 {
  color: #333; 
  background: #fff; 
  padding: .5em; 
  text-shadow: #f5f5f5 0 1px 0;
  border-radius: 2px; 
  box-shadow: 0px 0px 2px 0px #a6a6a6; 
  opacity: 0.9; 
  position: absolute;
  
  }

div.tooltip2.hidden {
	display: none;
	}



.BB {
	font-family: monospace;
	position: fixed;
	width: 200px;
	margin: -20px 0px;
	padding:10px;
	background: white;
	opacity: 0.75;
}

.BB2 {
	font-family: monospace;
	position: absolute;
	width: 300px;
	height: 20px;
	top: 55%;
	padding:10px;
	background: none;
	opacity: 0.95;
}


.BB2.hidden {
	display: none;
/* 	opacity: 0; */
	}

.copyright-notice {
	font-size: 8px;
	font-family: monospace;
	}




/* text { */
/*   font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; */
/*   font-family: "monospace"; */
/*   font-size: 12px; */
/*   text-anchor: middle; */
/* } */

text {
	font: 10px sans-serif;
	text-align: right;
	padding 3px
	margin 1px;
	color: white;
	}


rect {
  margin-top:0px;
  fill: none;
  pointer-events: all;
  border: grey;
}

.chart rect {
	fill: steelblue;
	stroke: white;
	opacity: 1;
}

.chart {
	position: absolute;
	background: 'white';
	border: 'black';
	opacity: 1;
	
	}

.chart.hidden {
	display: none;
	}


.logo{color:black;text-align:center;font-size:20px;line-height:0px;font-weight:bold;text-transform:lowercase;text-shadow:0 1px 2px rgba(0,0,0,0.4);background:}

line-height: 0.5em;

</style>

<body>

<div id="map"></div>
<div class = "BB2" div id = "clk" style="display:none"><h1 class="logo">Click on a circle!</h1></div>


<div class = "BB">
<h1>FCO Travel Advice</h1>

<p>World Map with FCO Travel Advice Hotspots Indicated.</p>

<p class="copyright-notice">D. Collins 2013.</p>
</div>



<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://d3js.org/topojson.v1.min.js"></script>
<script src="http://d3js.org/queue.v1.min.js"></script>
<script src="http://dpcollins.github.io/FCO2/date.format.js"></script>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>

<script type="text/javascript">

$(document).ready(function() {
    $("#clk").delay(750).fadeIn(500);
})

var W2 = screen.availWidth
var H2 = screen.availHeight

//  $(document).ready(function() {
//        $(window).resize(function() {
//          
//            bodyheight = $(window).height();
//            console.log(bodyheight)
//           $("svg").height(bodyheight/1.2);
//        	  
//         }); 
//     });
    
var width = W2,
    height = H2,
    active;
    
var radius = d3.scale.linear()
    .domain([100, 1e4])
    .range([1, 50]);

if (W2 > 1500)
	{Tx = 800;
	 Ty = 570;
	 Sc = 320;
	 }
else	{
// 			Tx = 480;
			Tx = 650;
			Ty = 430;
			Sc = 230;
		}	

var projection = d3.geo.mercator()
// 		.translate([480, 550])
		.translate([Tx,Ty])
		.scale(Sc);

var path = d3.geo.path()
    .projection(projection);
    

var svg = d3.select("#map").append("svg")
    .attr("width", width)
    .attr("height", height-50)
    .style("margin-left", W2/2-width/2);


svg.append("rect")
    .attr("id", "main")
    .attr("width", width)
    .attr("height", height-50)
    .on("click", reset);


var tooltip = d3.select("#map").append("div")
	.attr("class", "tooltip");
	
var tooltip1 = d3.select("#map").append("div")
	.attr("class", "tooltip1");

var tooltip2 = d3.select("#map").append("div")
	.attr("class", "tooltip2");

// queue()
//     .defer(d3.json, "http://localhost:8888/Documents/World_FCO/world-110m.json")
//     .defer(d3.tsv, "http://localhost:8888/Documents/World_FCO/world-country-names.tsv")
//     .defer(d3.csv, "http://localhost:8888/Documents/World_FCO/cities.csv")
//     .defer(d3.csv, "http://localhost:8888/Documents/World_FCO/World_Visits.csv")
//     .await(ready);

queue()
		.defer(d3.json, "http://dpcollins.github.io/FCO2/world-110m.json")
    	.defer(d3.tsv, "http://dpcollins.github.io/FCO2/world-country-names.tsv")
//      .defer(d3.csv, "http://localhost:8888/Documents/World_FCO/cities.csv")
    	.defer(d3.csv, "http://dpcollins.github.io/FCO2/World_Visits.csv")
    	.await(ready);    
    
function ready(error, world, names) {

      countries = topojson.feature(world, world.objects.countries).features,
      neighbors = topojson.neighbors(world.objects.countries.geometries),
      i = -1,
      n = countries.length;

// countries.forEach(function(d,i) { 
//     d.name = names.filter(function(n) { return d.id == n.id; })[0].name; 
//   });

countries = countries.filter(function(d) {
    return names.some(function(n) {
      if (d.id == n.id) return d.name = n.name;
    });})



country = svg.selectAll(".country").data(countries);

  country
   .enter()
    .insert("path")
    .attr("class", "country")    
      .attr("title", function(d,i) { return d.name; })
      .attr("d", path)
//       .style("fill", function(d, i) { return color(d.color = d3.max(neighbors[i], function(n) { return countries[n].color; }) + 1 | 0); });

    //Show/hide tooltip
    country
      .on("mousemove", function(d,i) {
        var mouse = d3.mouse(svg.node()).map( function(d) { return parseInt(d); } );

        tooltip
          .classed("hidden", false)
          .attr("style", "left:"+(mouse[0]+5)+"px;top:"+(mouse[1] - 50)+"px")
          .html(d.name)
      })
     .on("mouseout", function() {
   	 			tooltip.classed("hidden", true)})
   	 .on("click", click)

// Loading lat lon figures as test ////////////////////////////////////////////////
FG = []
GG = []
XZ = []
DZ = []
DZ2 = []
DZ3 = []

// d3.csv("http://localhost:8888/Documents/FCO2/WV2TEST.csv", function(error, data) {
d3.csv("http://dpcollins.github.io/FCO2/WV2TEST.csv", function(error, data) {
//     d3.csv("http://dpcollins.github.io/FCO2/WV2.csv", function(error, data) {
    DZ.push(data)
    dt = DZ[0][13].date
    dt2 = dt.split('/')
    dt3 = dt2.reverse()
    dt4 = dt3.join('/')
    date =  new Date(dt4)
    date3 = new Date(date.setDate(date.getDate()+1))
    UD = date3.format("dd-mm-yyyy")
	d3.select('body').append('text').text("Last Updated: "+UD).style("position", "absolute").style("top", 95+'%').style("right", 1+'%').style('color', 'black').style('font-size', '12px')    
    
    for (i=0;i<DZ[0].length;i++) 
    if (DZ[0][i].pct_change != '') {
    DZ2.push(parseFloat(DZ[0][i].pct_change))
    DZ3.push(parseFloat(DZ[0][i].pageviews))}
    
    svg.selectAll("circle")
       .data(data)
       .enter()
       .append("circle")
       .attr("cx", function(d) {
               return projection([d.lon, d.lat])[0]; console.log(d.lon);
       })
       .attr("cy", function(d) {
               return projection([d.lon, d.lat])[1];
       })
       .attr("r", function(d) {if (d.pageviews!=0) {
       					return radius(d.pageviews)} })

	  .style("fill", function(d)
       					{
       					if (d.pct_change !='' && d.pct_change < 0) {FG.push(parseFloat(d.pct_change)); 
       					
       					var color = d3.scale.linear().domain([d3.min(DZ2),0]).range(['#F00000','#A80000'])}  
       					
       					
       					else if (d.pct_change !='' && d.pct_change > 0) { GG.push(parseFloat(d.pct_change));
       					
       					var color = d3.scale.linear().domain([0, d3.max(DZ2)]).range(['#186800','#28F000'])}
       					
       					else {console.log('error'); var color = d3.scale.linear().domain([0, 0]).range(['black','white'])}
       					
       					
       					
       					return color(d.pct_change)
       					}) 
//       			
      
//  .style("fill", function(d) {if (d.pct_change > 0)
// 	 		{FC = '+'; FF = 'Green'}
//      	else 
//      		{FC = ''; FF = 'Red'} return FF })
       .style("opacity", 0.7)
       .style("stroke", '#fff')
       .style("stroke-width", 0.5);
       
//        })
// x = function(d) {return xz = data}
XZ.push(data)
l = []
u = []	

for (i in DZ[0]) {if (XZ[0][i].HighCFCO == 1) {l.push(i)}}

for (t in l)
{for (i in countries) {if (countries[i].name == DZ[0][l[t]].country) {u.push(i)}}
d3.select(country[0][u[u.length-1]]).style("fill",'darkgrey')
.on("mouseover",  function() {d3.select(this).style("fill", "red")}) 
.on("mouseout", function() {d3.select(this).style("fill", "darkgrey").attr("opacity", 1)})

}

 


svg.selectAll("circle")
	.on("mouseover", function(d,i) {
	  d3.select(this).style("stroke-width", function(d) {
	  var lw = d3.scale.linear().domain([0, d3.max(DZ3)]).range([0.75,5.5])
	  return lw(d.pageviews) })
	  
	  
	  mouse = d3.mouse(svg.node()).map( function(d) { return parseInt(d); } );
	 
	 if (mouse[0] > 0.8*W2)
	 	{ MP = -250}
	 else	
	 	{MP = 60}
	 
	 if (mouse[0] > 0.7*W2)
	 	{ MH = -300}
	 else
	 	{ MH = -100}
	 
	 if (mouse[1] > 0.65*H2)
	 	{ MV = -200;
	 	TTV = 250}
	 else
	 	{ MV= 20;
	 	TTV = 30}
	 
	 
	 if (d.ARC == 0) {
	 	MEDA = ""
	 	}
	 else
	 	{
	 	MEDA = "<br></br>"+"<b>"+"Arctic-Travel: "+"</b>" + d.ARC+'%' + "<font color=blue>" +' ('+ d.MedArctic+'%)' + "<font color=black>"
	 	}
	 if (d.SAHEL == 0) {
	 	SAH = ""
	 	}
	 else
	 	{
	 	SAH = "<br></br>"+"<b>"+"Sahel Region: "+"</b>" + d.SAHEL+'%' + "<font color=blue>" +' ('+ d.MedSahel +'%)' + "<font color=black>"
	 	}
l = []	 
 if (d.HighCFCO >0) {GGX = "red"} 
	 else
	 	{GGX = "black"}
	 
	 
	 
	 
	 
	 if (d.pct_change > 0)
	 	{FC = '+'; FF = 'Green'}
     else 
     	{FC = ''; FF = 'Red'}
     
  
    if (mouse[1]< 211) 
    	{VH2 = 100}
    else if (mouse[1] > 560) 
    	{VH2 = 220}    
    else {VH2 = 195}	
    	
    	
    	tooltip1
          .classed("hidden", false)
          .attr("style", "left:"+(mouse[0]+MP)+"px;top:"+(mouse[1] - VH2)+"px")
          .style("color", "black")
//           .text(d.city + " coords. Lat: " +d.lat +" Lon: " + d.lon)
        //   .html("<b>"+d.country+":</b>" +"<br>"+"</br>" + "Pageviews Yesterday:" + d.pageviews)
//           })

         
         .html("<font size=4>"+"<b>"+d.country+"</b>" + "<br></br>" + "<font size=3.5>" + " Pageviews Yesterday: " + "<b>"+parseInt(d.pageviews)+"</b>" + "<br>" + "</br>" + "Change: " + "<font color="+FF+">" + FC+d.pct_change+'%' +"<br></br>" + '----------------------------------------' //
         + "<br></br>"+ "<font color=black>"+"<font size=2.7em>" + "<b>"+"Summary: "+"</b>" + d.summary+'%' + "<font color=blue>" +' ('+ d.MedSum+'%)' + "<font color=black>" //
         
         + "<br></br>"+"<b>"+"Entry-Requirements: "+"</b>" + d.ERQ+'%' + "<font color=blue>" + ' ('+ d.Med_Entreq+'%)' + "<font color=black>"
         
         + "<br></br>"+"<b>"+"Safety and Security: "+"</b>" + d.SAS+'%' + "<font color=blue>" +' ('+ d.MedSS +'%)' + "<font color=black>"
         
         + "<br></br>"+"<b>"+"Health: "+"</b>" + d.health+'%' + "<font color=blue>" +' ('+ d.MedHealth+'%)' + "<font color=black>"
         
         + "<br></br>"+"<b>"+"Money: "+"</b>" + d.money+'%' + "<font color=blue>" +' ('+ d.MedMoney +'%)' + "<font color=black>"
         
         + "<br></br>"+"<b>"+"Terrorism: "+"</b>" + d.terrorism+'%' + "<font color=blue>" +' ('+ d.MedTerror+'%)' + "<font color=black>"
         
         + "<br></br>"+"<b>"+"Local Laws and Customs: "+"</b>" + d.LLC+'%' + "<font color=blue>"  +' ('+ d.MedLocal +'%)' + "<font color=black>"
         
         + "<br></br>"+"<b>"+"Natural Disasters: "+"</b>" + d.ND+'%' + "<font color=blue>" +' ('+ d.MedNatural+'%)' + "<font color=black>"
         
         + "<br></br>"+"<b>"+"Contact-FTA: "+"</b>" + "<font color="+GGX+">" + d.CFTA+'%' + "<font color=blue>" + ' ('+ d.MedContact +'%)' + "<font color=black>"
         
        //  + "<br></br>"+"<b>"+"Arctic-Travel: "+"</b>" + d.ARC+'%' +' ('+ d.MedArctic+'%)'
//          
//          + "<br></br>"+"<b>"+"Sahel Region: "+"</b>" + d.SAHEL+'%' +' ('+ d.MedSahel +'%)'
		
		+ MEDA
		+ SAH
         
         
         ) 
         
         })
         
         .style('align', 'center')
         .on("mouseout", function() {
		    d3.select(this).style("stroke-width", 0.5)
   	 	 	tooltip1.classed("hidden", true)})
   	 	 
   	 	 .on("click", click2)

})

// }
// })

GG = [1]
TT = []
GH = []
JJ = []

// filter = svg.append("defs")
// .append("filter")
// .attr("id","blur")
// .append("feGaussianBlur")
// .attr("stdDeviation",4);







function click2(d) {
 	
//  	filter.attr("stdDeviation",4)
//  	load()
 	TT = []
 	JJ = []

// 	function load() {
//  	d3.select('svg').attr("filter", "url(#blur)");
//  	console.log('load')}
 	
 	TT.push(d.country)
 	if (TT[0] == 'South-Korea ')
 		{TT[0] = 'South-Korea'}
 	for (var i=0;i<14;i++)
 	{
 	JJ.push(parseInt(XZ[0][i][TT[0]]))
 	}
 	d3.select('.BB2').classed('hidden', true)
 	var t = 12971100663,
//  	var t = 0
 	v = 70,
 	i = -1
 	
 	data = d3.range(14).map(next);
 	data2 = d3.range(14).map(next2);
 	data3 = d3.range(29).map(next2);
 	
 // 	GH.push(data)
//  	
 	function next() {i = i+1
 			   
    return {
      time: ++t,
//       value: v = ~~Math.max(10, Math.min(90, v + 10 * (Math.random() - .5)))
      value:  v = parseInt(JJ[i]),
      
    };
 		
 		   }
// 	
	function next2() {
    return {
      time: ++t,
      value: v = ~~ -350
    };
 		   }
	
	    w = 35,
      	h = 170;
  
    x = d3.scale.linear()
      .domain([0, 1])
      .range([0, w]);
  
   //  if (d3.max(JJ) > 1e3)
//     	{DD = 3*d3.max(JJ)}
//     else
//     	{DD = 1.1*d3.max(JJ)}
    
    DD = 1.05*d3.max(JJ)
    
    y = d3.scale.linear()
      .domain([-350, parseInt(DD)])
      .rangeRound([0, h]);
	
	var WID = 490;
	
	var mouse = d3.mouse(svg.node()).map( function(d) { return parseInt(d); } );
	console.log("HELLLLLLOOOOO")
	console.log(d.pct_change)
	
	chart = d3.select("body").append("svg")
		.attr("class", "chart")
		.attr("id", d.country)
		.attr("width", WID)
		.attr("height", 170)
		.attr("style", "left:"+(mouse[0]+MH)+"px;top:"+(mouse[1] + MV)+"px")
		
 
 
 rects = chart.selectAll("rect")
			.data(data2)
			.enter().append("rect")
			.attr("x", function(d, i) { return x(i); })
        	.attr("y", function(d) { return h - y(d.value) - .5; })
        	.attr("width", w)
        	.style("opacity",0.3)
        	// .attr("height", 0)
        	// .transition(1000)
        	.attr("height", function(d) { return 1.5*y(d.value); })


line = chart.append("svg:line")
				  .attr("x1", 0.5)
				  .attr("y1",h)
				  .attr("x2",0)
				  .attr("y2",h)
			//  	  .style("stroke", "rgb(6,120,155)")
				  .style("stroke", "grey")
				  .style("stroke-opacity", 0.5)
				  .style("stroke-width", 2);
 
line.transition().duration(1000)
	.attr("x2", WID-0.5)
	.style("stroke-opacity", 1)
	 
 

 
 cc =  chart.selectAll("text")
   			.data(data2)
   			.enter().append("text")
   			.attr("x", function(d, i) { return x(i)+.5; })		
   			.attr("y", function(d) { return h - y(d.value) - .5; })
   			.attr("dx", function(){if(document.body.style.MozTransform!=undefined) { return +w} else {return +w/2}})
   			.attr("dy", "1.1em")
   			.attr("text-anchor", "middle")
   			.text(function(d) { return d.value})
   			.style("fill", 'white')
   			.style("opacity", 0)
   
// if(document.body.style.MozTransform!=undefined) { cc.attr("dx", w)} 

rects.data(data)
   		.transition().duration(1000)
   		.attr("x", function(d, i) { return x(i); })
        .attr("y", function(d) { return h - y(d.value) - .5; })
        .attr("height", function(d) { return y(d.value); })
        .attr("width", w)
        .style("opacity", 1)
 		
  cc.data(data)
   		.transition().duration(1000)		
   		.attr("y", function(d) { return h - y(d.value) - .5; })
//    		.attr("dx", +w/2)
   		.attr("dx", function(){if(document.body.style.MozTransform!=undefined) { return +w} else {return +w/2}})
   		.attr("dy", "1.1em")
   		.attr("text-anchor", "middle")
   		.text(function(d) { return d.value})
   		.style("fill", 'white') 
   		.style("text-rendering", "optimizeLegibility")
   		.style("font-weight", 'normal')
   		.style("opacity", 1)  		
   		
 hj = d3.select('.chart').style('left')
 tj = d3.select('.tooltip2').style('width')
 hj2 = parseInt(hj.slice(0,hj.length-2))
 tj2 = parseInt(tj.slice(0,tj.length-2))
 
d3.selectAll('.chart')
 		.on("mouseover", function(d,i) {
// 	 		var mouse = d3.mouse(svg.node()).map( function(d) { return parseInt(d); } );
		G = d3.select(this).attr('id')
		G4 = parseInt(d3.select(this).style('left'))
		console.log(G4)
		console.log(G)
	 	
	 	tooltip2
          .classed("hidden", false)
//           .attr("style", "left:"+(mouse[0]+50)+"px;top:"+(mouse[1] - 110)+"px")
//           .attr("style", "left:"+(mouse[0] + WID/3.3)+"px;top:"+(mouse[1] - 30)+"px")
          .attr("style", "left:"+(G4 + WID/2 - 120)+"px;top:"+(mouse[1] - TTV)+"px")
          .style("color", "black") 
//           .html("Time series data for "+"<b>"+TT[TT.length-1]+"</b>")})	
// 		  .html("Time series data for "+"<b>"+G+"</b>")})
 	.html("Visits to "+"<b>"+G+"</b>" + " page over past 14 days")})
 .on("mouseout", function() {
   	 	 tooltip2.classed("hidden", true)})
 
  
    if (GG[0] == 1){
    chart.classed("hidden", false);
    tooltip1.classed("hidden", true)
    console.log('Hello')
    GG[0] = 2
    }
// 	.on("click", chart.classed("hidden", true)); 
// d3.select('.chart')
// 	.on("click", d3.select('.chart').remove())	
    else
    
//     {chart.classed("hidden",true)
    {d3.selectAll('.chart').remove()
    GG[0] = 1
    }
    
//     TT.push(d.country)
    
   
    return data}


d3.select('svg')
.on('click', high)

function high()  {
		
		GG[0] = 1
		
		}

function click(d) {
	
	if (active === d) return reset();
	svg.selectAll(".active").classed("active", false);
	d3.select(this).classed("active", active = d);
	
	var b = path.bounds(d);
	tt =  Math.max((b[1][0] - b[0][0]))
	console.log(tt)
	if (tt>300) {A = 2.5; B = 1.5} else {A = 1; B = 2}
	country.transition().duration(750).attr("transform",
		"translate("+projection.translate() + ")"
		+ "scale(" + (0.40*A) /(Math.max((b[1][0] - b[0][0]) )/ width, (b[1][1] - b[0][1]) / height) + ")"
		+ "translate(" + -(b[1][0] +b[0][0])/ B  + "," + -(b[1][1] + b[0][1]) / 2 + ")");
	
	svg.selectAll("circle").transition().duration(750).attr("transform",
		"translate("+projection.translate() + ")"
		+ "scale(" + (0.40*A) /(Math.max((b[1][0] - b[0][0]) )/ width, (b[1][1] - b[0][1]) / height) + ")"
		+ "translate(" + -(b[1][0] +b[0][0])/ B  + "," + -(b[1][1] + b[0][1]) / 2 + ")")
		.attr("r", function(d){if (d.pageviews>0) {
       					return radius(d.pageviews)} })
		.style("stroke-width", 0.3);

//     .attr("r", 10)
// 		.attr("r", 1);
		
	d3.selectAll('.chart').remove()
	filter.attr("stdDeviation",0)
    load()
	console.log(d.country)	
// 	GG = b
		
	return b	}
// });
	
}   // end of initial 'world' function




function reset() {
	console.log('reset')
	svg.selectAll(".active").classed("active", active = false);
	country.transition().duration(750).attr("transform", "")
	svg.selectAll("circle").transition().duration(750).attr("transform", "")
    .attr("r", function(d) {if (d.pageviews>0) {
       					return radius(d.pageviews)} })
	.style("stroke-width", 0.5)
	
	d3.selectAll('.chart').selectAll('rect').data(data3).transition().duration(1000)
	.attr("x", function(d, i) { return x(i); })
        .attr("y", function(d) { return h - y(d.value) - .5; })
        .attr("height", function(d) { return y(d.value); })
        .attr("width", w)
        .style("opacity", 0)
        

	
	 d3.selectAll('.chart').selectAll('text').data(data3)
   		.transition().duration(1000)		
   		.attr("y", function(d) { return h - y(d.value) - .5; })
   		.attr("dx", +w/2)
   		.attr("dy", "1.1em")
   		.attr("text-anchor", "middle")
//    		.text(function(d) { return d.value})
   		.style("fill", 'white') 
   		.style("opacity", 0) 
   		

	d3.selectAll('line').transition().duration(1000)
	.attr("x2", 0)
	.style("stroke-opacity", 0)


	d3.selectAll('.chart').transition().delay(500).remove()
	
// 	 filter.attr("stdDeviation",0);

}


TUP = []

// $(document).ready(function() {

d3.csv("http://dpcollins.github.io/FCO2/TopUps.csv", function(error, data) {
	TUP.push(data)
	body = d3.select('body')
	
	
	svg2 = body.append('svg')
			  .attr('height', 20+'%')
			  .attr('width', '25%')
			  .style('position', 'fixed')
			  .style('bottom', 5+'%')
// 			  .style('margin-bottom', 10)
		 
		  rect1 = svg2.append('rect').transition().duration(500)
		  			.attr('width', 295)
		  			.attr('height', 80+'%')
		  			.attr('x', 5)
		  			.attr('y', 5+'%')
		  			.style('fill', 'lightgrey')
		  			.style('opacity', 0.5)
		  			.attr('stroke', 'darkgrey')
		  			.attr('filter', "url(#dropshadow)");
		  			
function draw(i) {
  				textK = svg2.append('foreignObject')
                        .attr('x', 1)
                        .attr('y', '6%')
                        .attr('width', 290)
                        .attr('height', 80+'%')
                        .append("xhtml:body")
                        .style("font-family", 'monospace')
                        .style("opacity", 0)
                                                              
// //     			.html('<div style="width: 285px;">This is some information about whatever</div>')
    			.html('<div style="width: 285px;">'+ '<b>' + TUP[0][i]['Updated_at'] + '   ' + TUP[0][i]['Country'] + '</b>' + '<br></br>'+ '   ' + TUP[0][i]['Latest_Update']+'</div>')
				
				textK.transition().duration(1000).style("opacity",1)
				
				setTimeout(function() {textK.transition().duration(1000).style("opacity", 0).remove()}, 7000)
}

draw(0)

setInterval(function() {Ddraw()}, 9000);

function Ddraw() {

shuffle = function(v){
    for(var j, x, i = v.length; i; j = parseInt(Math.random() * i), x = v[--i], v[i] = v[j], v[j] = x);
    return v;
};

var list = []
for (var ik = 0; ik <= TUP[0].length; ik++) {
    list.push(ik);
}

a = shuffle(list) 
draw(list[0])

}

var defs = svg.append("defs");

  var filter = defs.append("filter")
      .attr("id", "dropshadow")
      .attr("height", "130%")

  filter.append("feGaussianBlur")
      .attr("in", "SourceAlpha")
      .attr("stdDeviation", 5)
      .attr("result", "blur");
  filter.append("feOffset")
      .attr("in", "blur")
      .attr("dx", 5)
      .attr("dy", 5)
      .attr("result", "offsetBlur");

  var feMerge = filter.append("feMerge");

  feMerge.append("feMergeNode")
      .attr("in", "offsetBlur")
  feMerge.append("feMergeNode")
      .attr("in", "SourceGraphic");





})































// 	.attr("r", 3);}


// d3.select(self.frameElement).style("height", height + "px");

// function trans() {
// k = 0
// svg.selectAll('circle')
// 	.transition()
// 	.duration(3000)
// 	.style("fill",function(d) {if (d.lat>0) {return 'purple'} else {return 'blue'}})
// 	.attr('r',function(d) {if (d.lat>0) {return 10} else {k = k+1; return 5; k}})
//    
// d3.select("#map").append("div")
// 	.classed("hidden", false)
// 	.attr("class", "tooltip")
// 	.attr("style", "left:"+1000+"px"+";"+"top:"+500+'px')
// 	.html(k+" Countries in Southern Hemisphere")
// 
// }

</script>

